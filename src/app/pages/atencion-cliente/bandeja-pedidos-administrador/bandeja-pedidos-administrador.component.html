<div class="container-fluid mt-5" style="padding: 0px 60px;">
	<div class="card shadow-lg p-4 rounded-4">
		<h2 class="mb-4 text-center">Bandeja de Pedidos (Administrador)</h2>

		<button class="btn-forward-rosa position-absolute" (click)="router.navigate(['/pages/produccion/bandeja-produccion'])">
			<span>Siguiente: Bandeja Producción</span>
			<i class="bi bi-arrow-right"></i>
		</button>

		<!-- Tabla de Pedidos -->
		<div class="table-responsive">
			<table class="table table-bordered align-middle mt-0">
			<thead class="table-primary">
				<tr>
					<th scope="col">
						<input class="form-check-input"
							type="checkbox"
							[checked]="isTodosSeleccionadosPagina()"
							(change)="toggleSeleccionTodosPagina($event)">
					</th>
					<th scope="col">Código</th>
					<th scope="col">Fecha de pedido</th>
					<th scope="col">Cliente</th>
					<th scope="col">Monto (S/)</th>
					<th scope="col">Estado</th>
          			<th scope="col">FEE (Fecha Estimada de Entrega)</th>
					<th scope="col">Método de Pago</th>
					<th scope="col" style="min-width: 260px;">Acciones</th>
				</tr>
			</thead>
			<tbody>
				@for (item of pedidos; track $index) {
				<tr [class]="item.pagoParcial == true && item.pagoCompleto === false ? 'table-warning' : (item.estadoPedido.idEstadoPedido === 2 ? 'table-success' : '')">
					<td>
						<input class="form-check-input"
							type="checkbox"
							[checked]="isSeleccionado(item.idPedido)"
							(change)="toggleSeleccionIndividual(item.idPedido, $event)"
							[disabled]="item.estadoPedido.idEstadoPedido != 2">
					</td>
					<td>{{item.idPedido}}</td>
					<td>{{item.fechaPedido | date: 'dd/MM/yyyy'}}</td>
					<td>{{item.cliente.nombres}} {{item.cliente.apellidos}}</td>
					<td>S/ {{item.montoTotal.toFixed(2)}}</td>
					<td>{{item.estadoPedido.descripcion}}</td>
					<td>
						<input 
						type="date" 
						class="form-control" 
						[value]="item.fechaEstimadaEntrega" 
						(change)="editarFechaEstimadaEntrega(item, $event)" 
						/>
					</td>
					<td>{{item.pagoPedido ? item.pagoPedido.tipoPago.descripcion : '-'}}</td>
					<td>
						<button 
							class="btn btn-primary me-2" 
							(click)="router.navigate(['/pages/atencion-cliente/registro-pedido', item.idPedido])"
							ngbTooltip="Editar pedido"
							placement="top"
						>
							<i class="bi bi-pencil-square"></i>
						</button>
						<button 
							class="btn btn-dark me-2" 
							(click)="enviarProduccionSingle(item)" 
							[disabled]="item.estadoPedido.idEstadoPedido != 2"
							ngbTooltip="Enviar pedido a producción"
							placement="top"
						>
							<i class="bi bi-flask"></i>
						</button>
						<button 
							class="btn btn-info me-2" 
							(click)="router.navigate(['/pages/atencion-cliente/trazabilidad-pedido', item.idPedido])"
							ngbTooltip="Ver trazabilidad del pedido"
							placement="top"
						>
							<i class="bi bi-clock-history"></i>
						</button>
						<button 
							class="btn btn-warning me-2" 
							(click)="verComprobantePago(item, comprobantePagoModal)"
							[disabled]="!tieneComprobantePago(item)"
							ngbTooltip="Ver comprobante de pago"
							placement="top"
						>
							<i class="bi bi-receipt"></i>
						</button>
						<button
							class="btn btn-success me-2"
							(click)="imprimirHojaPedido(item.idPedido)"
							[disabled]="loadingPDF[item.idPedido]"
							ngbTooltip="Imprimir hoja de pedido (PDF)"
							placement="top"
						>
							<i class="bi bi-file-earmark-pdf"></i>
							@if (loadingPDF[item.idPedido]) {
								<span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>
							}
						</button>
						@if (item.pagoCompleto === false && item.pagoParcial === true) {
							<button 
								class="btn btn-secondary me-2" 
								(click)="completarPagoParcial(item)"
								ngbTooltip="Completar pago parcial"
								placement="top"
							>
								<i class="bi bi-cash-coin"></i>
							</button>
						}
						<button 
							[disabled]="item.estadoPedido.idEstadoPedido >= 2" 
							class="btn btn-danger" 
							(click)="borrarPedido(item.idPedido)"
							ngbTooltip="Eliminar pedido"
							placement="top"
						>
							<i class="bi bi-trash3-fill"></i>
						</button>
					</td>
				</tr>
				}
			</tbody>
		</table>
		</div>

		<div class="d-flex justify-content-between p-2">
			<ngb-pagination
				[collectionSize]="collectionSize"
				[(page)]="page"
				[pageSize]="pageSize"
				(pageChange)="refreshPedidos()"
				class="pagination-rosa"
			>
			</ngb-pagination>

			<select class="form-select" style="width: auto" [(ngModel)]="pageSize" (ngModelChange)="refreshPedidos()">
				<option [ngValue]="5">5 items</option>
				<option [ngValue]="10">10 items</option>
				<option [ngValue]="15">15 items</option>
			</select>
		</div>

		<!-- Botones de Acción -->
		<div class="d-flex justify-content-center align-items-center mb-4">
			@if (lstPedidosSeleccionados.length > 0) {
				<button class="btn btn-dark me-2" (click)="enviarProduccionMasivo()"><i class="bi bi-send"></i> Enviar a Producción</button>
			}
			<button class="btn btn-primary me-2" (click)="router.navigate(['/pages/atencion-cliente/registro-pedido'])"><i class="bi bi-plus-circle"></i> Nuevo Pedido</button>
			<!-- <button class="btn btn-primary me-2">Historial de Pedidos</button>
			<button class="btn btn-primary">Buscar Pedido</button> -->
		</div>
	</div>
</div>

<app-toasts></app-toasts>

<ng-template #comprobantePagoModal let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Comprobante de Pago</h4>
		<button
			type="button"
			class="btn-close"
			aria-label="Close"
			(click)="modal.dismiss('Cross click')"
		></button>
	</div>
	<div class="modal-body">
		@if (pedidoSeleccionado && pedidoSeleccionado.pagoPedido && pedidoSeleccionado.pagoPedido.urlArchivo) {
			<div class="mb-3">
				<p><strong>Pedido:</strong> {{ pedidoSeleccionado.idPedido }}</p>
				<p><strong>Cliente:</strong> {{ pedidoSeleccionado.cliente?.nombres }} {{ pedidoSeleccionado.cliente?.apellidos }}</p>
				<p><strong>Método de Pago:</strong> {{ pedidoSeleccionado.pagoPedido.tipoPago?.descripcion || 'N/A' }}</p>
				<p><strong>Monto:</strong> S/ {{ pedidoSeleccionado.montoTotal?.toFixed(2) }}</p>
			</div>
			
			@if (urlComprobanteValida) {
				<div class="text-center">
					<iframe 
						[src]="urlComprobanteSanitizada" 
						width="100%" 
						height="500px" 
						frameborder="0"
						style="border: 1px solid #ddd; border-radius: 8px;"
						allowfullscreen>
					</iframe>
				</div>
				<div class="mt-3 text-center">
					<a 
						[href]="pedidoSeleccionado.pagoPedido.urlArchivo" 
						target="_blank" 
						class="btn btn-outline-primary"
					>
						<i class="bi bi-box-arrow-up-right"></i> Abrir en nueva ventana
					</a>
				</div>
			} @else {
				<div class="alert alert-warning text-center">
					<i class="bi bi-exclamation-triangle fs-1"></i>
					<p class="mt-2">No se puede visualizar el comprobante de pago</p>
					@if (pedidoSeleccionado.pagoPedido.urlArchivo) {
						<a 
							[href]="pedidoSeleccionado.pagoPedido.urlArchivo" 
							target="_blank" 
							class="btn btn-primary"
						>
							<i class="bi bi-box-arrow-up-right"></i> Ver archivo original
						</a>
					}
				</div>
			}
		} @else {
			<div class="alert alert-info text-center">
				<i class="bi bi-info-circle fs-1"></i>
				<p class="mt-2">No hay comprobante de pago disponible para este pedido</p>
			</div>
		}
	</div>
	<div class="modal-footer">
		<button
			type="button"
			class="btn btn-secondary"
			(click)="modal.close()"
		>
			Cerrar
		</button>
	</div>
</ng-template>

<ng-template #successTpl>
	<div class="d-flex align-items-center">
		<i class="bi bi-check-circle-fill me-2"></i>
		Fecha de entrega actualizada correctamente.
	</div>
</ng-template>
