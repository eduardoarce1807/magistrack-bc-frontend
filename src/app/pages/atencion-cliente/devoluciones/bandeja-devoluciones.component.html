<div class="container-fluid devolucion-container">
  <!-- Header con estadísticas -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 text-devolucion-primary">
          <i class="bi bi-arrow-return-left me-2 devolucion-icon"></i>
          Gestión de Devoluciones
        </h4>
        <button 
          class="btn btn-primary"
          (click)="crearDevolucion()"
          [disabled]="cargando">
          <i class="bi bi-plus-circle me-2"></i>
          Nueva Devolución
        </button>
      </div>
      
      <!-- Estadísticas rápidas -->
      <div class="row" *ngIf="catalogos?.estadisticas">
        <div class="col-md-2 col-sm-4 col-6 mb-2">
          <div class="card bg-primary text-white">
            <div class="card-body text-center py-2">
              <h6 class="mb-1">{{ catalogos?.estadisticas?.totalDevoluciones || 0 }}</h6>
              <small>Total</small>
            </div>
          </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6 mb-2">
          <div class="card bg-success text-white">
            <div class="card-body text-center py-2">
              <h6 class="mb-1">{{ catalogos?.estadisticas?.devolucionesRegistradas || 0 }}</h6>
              <small>Registradas</small>
            </div>
          </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6 mb-2">
          <div class="card bg-warning text-white">
            <div class="card-body text-center py-2">
              <h6 class="mb-1">{{ catalogos?.estadisticas?.devolucionesEnProceso || 0 }}</h6>
              <small>En Proceso</small>
            </div>
          </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6 mb-2">
          <div class="card bg-info text-white">
            <div class="card-body text-center py-2">
              <h6 class="mb-1">{{ catalogos?.estadisticas?.devolucionesCompletadas || 0 }}</h6>
              <small>Completadas</small>
            </div>
          </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6 mb-2">
          <div class="card bg-danger text-white">
            <div class="card-body text-center py-2">
              <h6 class="mb-1">{{ catalogos?.estadisticas?.devolucionesCanceladas || 0 }}</h6>
              <small>Canceladas</small>
            </div>
          </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6 mb-2">
          <div class="card bg-secondary text-white">
            <div class="card-body text-center py-2">
              <h6 class="mb-1">{{ catalogos?.estadisticas?.devolucionesDelMes || 0 }}</h6>
              <small>Este Mes</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-header">
      <h6 class="mb-0">
        <i class="bi bi-funnel me-2"></i>
        Filtros de Búsqueda
      </h6>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <!-- Búsqueda general -->
        <div class="col-md-3">
          <label class="form-label">Buscar:</label>
          <input 
            type="text" 
            class="form-control"
            [(ngModel)]="query"
            placeholder="ID devolución, pedido, cliente..."
            (keyup.enter)="aplicarFiltros()">
        </div>
        
        <!-- Fecha inicio -->
        <div class="col-md-2">
          <label class="form-label">Fecha Inicio:</label>
          <input 
            type="date" 
            class="form-control"
            [(ngModel)]="fechaInicio">
        </div>
        
        <!-- Fecha fin -->
        <div class="col-md-2">
          <label class="form-label">Fecha Fin:</label>
          <input 
            type="date" 
            class="form-control"
            [(ngModel)]="fechaFin">
        </div>
        
        <!-- Estado -->
        <div class="col-md-2">
          <label class="form-label">Estado:</label>
          <select 
            class="form-select"
            [(ngModel)]="estadoSeleccionado"
            (change)="aplicarFiltros()">
            <option [value]="null">Todos los estados</option>
            <option 
              *ngFor="let estado of catalogos?.estados" 
              [value]="estado.idEstadoDevolucion">
              {{ estado.descripcion }}
            </option>
          </select>
        </div>
        
        <!-- Acción -->
        <div class="col-md-2">
          <label class="form-label">Acción:</label>
          <select 
            class="form-select"
            [(ngModel)]="accionSeleccionada"
            (change)="aplicarFiltros()">
            <option [value]="null">Todas las acciones</option>
            <option 
              *ngFor="let accion of catalogos?.acciones" 
              [value]="accion.idAccionDevolucion">
              {{ accion.descripcion }}
            </option>
          </select>
        </div>
        
        <!-- Botones -->
        <div class="col-md-1">
          <label class="form-label">&nbsp;</label>
          <div class="d-flex gap-2">
            <button 
              class="btn btn-primary btn-sm"
              (click)="aplicarFiltros()"
              [disabled]="cargando">
              <i class="bi bi-search"></i>
            </button>
            <button 
              class="btn btn-outline-secondary btn-sm"
              (click)="limpiarFiltros()"
              [disabled]="cargando">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de devoluciones -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0">
        Listado de Devoluciones
        <span class="badge bg-primary ms-2">{{ totalElementos }}</span>
      </h6>
      <div class="d-flex gap-2">
        <select 
          class="form-select form-select-sm"
          [(ngModel)]="elementosPorPagina"
          (change)="cambiarTamanoPagina()"
          style="width: auto;">
          <option *ngFor="let opcion of opcionesPaginacion" [value]="opcion">
            {{ opcion }} por página
          </option>
        </select>
      </div>
    </div>
    
    <div class="card-body p-0">
      <!-- Loading indicator -->
      <div *ngIf="cargando" class="text-center p-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2 mb-0">Cargando devoluciones...</p>
      </div>

      <!-- Tabla responsiva -->
      <div class="table-responsive" *ngIf="!cargando">
        <table class="table table-hover mb-0 devolucion-table">
          <thead class="table-light">
            <tr>
              <th scope="col" style="width: 120px;">
                <button 
                  class="btn btn-link p-0 text-decoration-none fw-bold"
                  (click)="cambiarOrdenamiento('idDevolucion')">
                  ID Devolución
                  <i class="bi bi-arrow-down-up ms-1"></i>
                </button>
              </th>
              <th scope="col" style="width: 120px;">
                <button 
                  class="btn btn-link p-0 text-decoration-none fw-bold"
                  (click)="cambiarOrdenamiento('idPedido')">
                  ID Pedido
                  <i class="bi bi-arrow-down-up ms-1"></i>
                </button>
              </th>
              <th scope="col" style="width: 180px;">Cliente</th>
              <th scope="col" style="width: 140px;">
                <button 
                  class="btn btn-link p-0 text-decoration-none fw-bold"
                  (click)="cambiarOrdenamiento('fechaRegistro')">
                  Fecha Registro
                  <i class="bi bi-arrow-down-up ms-1"></i>
                </button>
              </th>
              <th scope="col" style="width: 140px;">Motivo</th>
              <th scope="col" style="width: 140px;">Acción</th>
              <th scope="col" style="width: 120px;">
                <button 
                  class="btn btn-link p-0 text-decoration-none fw-bold"
                  (click)="cambiarOrdenamiento('estadoDevolucion')">
                  Estado
                  <i class="bi bi-arrow-down-up ms-1"></i>
                </button>
              </th>
              <th scope="col" style="width: 100px;" class="text-end">
                <button 
                  class="btn btn-link p-0 text-decoration-none fw-bold"
                  (click)="cambiarOrdenamiento('montoDevolucion')">
                  Monto
                  <i class="bi bi-arrow-down-up ms-1"></i>
                </button>
              </th>
              <th scope="col" style="width: 180px;" class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let devolucion of devoluciones; trackBy: trackByDevolucion">
              <!-- ID Devolución -->
              <td>
                <strong class="text-primary">{{ devolucion.idDevolucion }}</strong>
              </td>
              
              <!-- ID Pedido -->
              <td>
                <span class="badge bg-secondary">{{ devolucion.idPedido }}</span>
              </td>
              
              <!-- Cliente -->
              <td>
                <div class="small">
                  <strong>{{ devolucion.nombreCliente }}</strong><br>
                  <span class="text-muted">{{ devolucion.numeroDocumentoCliente }}</span>
                </div>
              </td>
              
              <!-- Fecha Registro -->
              <td>
                <small>{{ formatearFechaDisplay(devolucion.fechaRegistro) }}</small>
              </td>
              
              <!-- Motivo -->
              <td>
                <span class="badge bg-light text-dark small">
                  {{ devolucion.motivoDevolucion }}
                </span>
              </td>
              
              <!-- Acción -->
              <td>
                <span class="badge bg-info text-white small">
                  {{ devolucion.accionDevolucion }}
                </span>
              </td>
              
              <!-- Estado -->
              <td>
                <span 
                  class="badge small estado-badge"
                  [class.estado-registrada]="devolucion.estadoDevolucion === 'Registrada'"
                  [class.estado-en-proceso]="devolucion.estadoDevolucion === 'En Proceso'"
                  [class.estado-completada]="devolucion.estadoDevolucion === 'Completada'"
                  [class.estado-cancelada]="devolucion.estadoDevolucion === 'Cancelada'"
                  [style.background-color]="devolucion.colorEstado"
                  [style.color]="'white'"
                  [title]="devolucion.estadoDevolucion">
                  <i [class]="obtenerIconoEstado(devolucion.estadoDevolucion)" class="me-1 devolucion-icon"></i>
                  {{ devolucion.estadoDevolucion }}
                </span>
              </td>
              
              <!-- Monto -->
              <td class="text-end">
                <strong>{{ formatearMonto(devolucion.montoDevolucion) }}</strong>
              </td>
              
              <!-- Acciones -->
              <td class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                  <!-- Ver detalle -->
                  <button 
                    class="btn btn-outline-info"
                    (click)="verDetalle(devolucion.idDevolucion)"
                    title="Ver detalle">
                    <i class="bi bi-eye"></i>
                  </button>
                  
                  <!-- Editar -->
                  <button 
                    class="btn btn-outline-warning"
                    (click)="editarDevolucion(devolucion.idDevolucion)"
                    title="Editar"
                    *ngIf="devolucion.estadoDevolucion !== 'Completada' && devolucion.estadoDevolucion !== 'Cancelada'">
                    <i class="bi bi-pencil"></i>
                  </button>
                  
                  <!-- Cambio de estado rápido -->
                  <button 
                    class="btn btn-outline-success"
                    (click)="mostrarCambioEstadoModal(devolucion)"
                    title="Cambiar estado"
                    *ngIf="devolucion.estadoDevolucion !== 'Completada' && devolucion.estadoDevolucion !== 'Cancelada'">
                    <i class="bi bi-arrow-repeat"></i>
                  </button>
                  
                  <!-- Eliminar -->
                  <button 
                    class="btn btn-outline-danger"
                    (click)="eliminarDevolucion(devolucion)"
                    title="Eliminar"
                    *ngIf="devolucion.estadoDevolucion === 'Registrada'">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            
            <!-- Mensaje cuando no hay datos -->
            <tr *ngIf="devoluciones.length === 0">
              <td colspan="9" class="text-center py-4">
                <div class="text-muted">
                  <i class="bi bi-inbox display-4"></i>
                  <p class="mt-2 mb-0">No se encontraron devoluciones</p>
                  <small>Intente ajustar los filtros de búsqueda</small>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Paginación -->
    <div class="card-footer" *ngIf="!cargando && totalElementos > 0">
      <div class="d-flex justify-content-between align-items-center">
        <span class="text-muted small">
          Mostrando {{ (paginaActual * elementosPorPagina) + 1 }} - 
          {{ Math.min((paginaActual + 1) * elementosPorPagina, totalElementos) }} 
          de {{ totalElementos }} resultados
        </span>
        
        <nav>
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" [class.disabled]="paginaActual === 0">
              <button 
                class="page-link"
                (click)="cambiarPagina({page: 1})"
                [disabled]="paginaActual === 0">
                <i class="bi bi-chevron-left"></i>
              </button>
            </li>
            
            <ng-container *ngFor="let i of generarArrayPaginacion(); trackBy: trackByPaginacion">
              <li 
                class="page-item"
                [class.active]="i === paginaActual"
                *ngIf="i >= paginaActual - 2 && i <= paginaActual + 2">
                <button 
                  class="page-link"
                  (click)="cambiarPagina({page: i + 1})">
                  {{ i + 1 }}
                </button>
              </li>
            </ng-container>
            
            <li class="page-item" [class.disabled]="paginaActual === totalPaginas - 1">
              <button 
                class="page-link"
                (click)="cambiarPagina({page: paginaActual + 2})"
                [disabled]="paginaActual === totalPaginas - 1">
                <i class="bi bi-chevron-right"></i>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>