<div class="container-fluid mt-5" style="padding: 0px 60px;">
	<div class="card shadow-lg p-4 rounded-4">
		<h2 class="mb-4 text-center">Visualizador de Pagos</h2>

        <div class="row gx-3 gy-2 align-items-end mb-4">
            <div class="col-auto">
                <label for="fechaInicio" class="form-label">Fecha Inicio</label>
                <input
                    type="date"
                    id="fechaInicio"
                    name="fechaInicio"
                    class="form-control"
                    [(ngModel)]="fechaInicio"
                />
            </div>
            <div class="col-auto">
                <label for="fechaFin" class="form-label">Fecha Fin</label>
                <input
                    type="date"
                    id="fechaFin"
                    name="fechaFin"
                    class="form-control"
                    [(ngModel)]="fechaFin"
                />
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" (click)="cargarPagos()">Buscar</button>
            </div>
        </div>

		<!-- Tabla de Pedidos -->
		<table class="table table-bordered align-middle mt-0">
			<thead class="table-primary">
				<tr>
					<th scope="col">Pedido/Referencia</th>
					<th scope="col">Método de Pago</th>
                    <th scope="col">Monto</th>
					<th scope="col">N° Operación</th>
					<th scope="col">Cliente</th>
					<th scope="col">Fecha de Pago</th>
          			<th scope="col">Banco</th>
					<th scope="col">Adjunto</th>
				</tr>
			</thead>
			<tbody>
				@for (item of pagos; track $index) {
				<tr>
					<td>{{item.pedido.idPedido}}</td>
					<td>{{item.tipoPago ? item.tipoPago.descripcion : '-'}}</td>
                    <td>S/ {{item.pedido.montoTotal.toFixed(2)}}</td>
					<td>{{item.numeroOperacion}}</td>
					<td>{{item.pedido.cliente.nombres}} {{item.pedido.cliente.apellidos}}</td>
					<td>{{item.fechaPago}}</td>
					<td>{{item.banco ? item.banco.nombre : '-'}}</td>
                    <td>
						@if(item.urlArchivo){
							<a ngbTooltip="Ver archivo adjunto" [href]="item.urlArchivo" target="_blank" class="btn btn-info btn-sm me-1">
								<i class="bi bi-file-earmark-text"></i>
							</a>
						}
						<button 
							class="btn btn-warning btn-sm" 
							(click)="abrirModalAdjunto(item, modalAdjunto)"
							ngbTooltip="{{ item.urlArchivo ? 'Editar archivo adjunto' : 'Agregar archivo adjunto' }}"
							placement="top"
						>
							<i class="bi {{ item.urlArchivo ? 'bi-pencil' : 'bi-plus-circle' }}"></i>
						</button>
					</td>
				</tr>
				}
			</tbody>
		</table>

		<div class="d-flex justify-content-between p-2">
			<ngb-pagination
				[collectionSize]="collectionSize"
				[(page)]="page"
				[pageSize]="pageSize"
				(pageChange)="refreshPagos()"
				class="pagination-rosa"
			>
			</ngb-pagination>

			<select class="form-select" style="width: auto" [(ngModel)]="pageSize" (ngModelChange)="refreshPagos()">
				<option [ngValue]="5">5 items</option>
				<option [ngValue]="10">10 items</option>
				<option [ngValue]="15">15 items</option>
			</select>
		</div>

		<!-- Botones de Acción -->
		<!-- <div class="d-flex justify-content-center align-items-center mb-4">
			<button class="btn btn-primary me-2" (click)="router.navigate(['/pages/atencion-cliente/registro-pedido'])"><i class="bi bi-plus-circle"></i> Nuevo Pedido</button>

		</div> -->
	</div>
</div>

<!-- Modal para adjuntar archivo -->
<ng-template #modalAdjunto let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">
			{{ pagoSeleccionado?.urlArchivo ? 'Editar' : 'Agregar' }} Archivo Adjunto
		</h4>
		<button
			type="button"
			class="btn-close"
			aria-label="Close"
			(click)="modal.dismiss('Cross click')"
		></button>
	</div>
	<div class="modal-body">
		@if (pagoSeleccionado) {
			<div class="mb-3">
				<p><strong>Pedido:</strong> {{ pagoSeleccionado.pedido.idPedido }}</p>
				<p><strong>Cliente:</strong> {{ pagoSeleccionado.pedido.cliente.nombres }} {{ pagoSeleccionado.pedido.cliente.apellidos }}</p>
				<p><strong>Monto:</strong> S/ {{ pagoSeleccionado.pedido.montoTotal?.toFixed(2) }}</p>
			</div>
			
			@if (pagoSeleccionado.urlArchivo) {
				<div class="alert alert-info">
					<p class="mb-2"><strong>Archivo actual:</strong></p>
					<a [href]="pagoSeleccionado.urlArchivo" target="_blank" class="btn btn-outline-primary btn-sm">
						<i class="bi bi-file-earmark-text"></i> Ver archivo actual
					</a>
				</div>
			}
			
			<div class="mb-3">
				<label for="archivoAdjunto" class="form-label">
					{{ pagoSeleccionado.urlArchivo ? 'Reemplazar archivo' : 'Seleccionar archivo' }}
					<span class="text-danger">*</span>
				</label>
				<input
					type="file"
					id="archivoAdjunto"
					class="form-control"
					accept=".jpg,.jpeg,.png,.pdf"
					(change)="onArchivoAdjuntoSeleccionado($event)"
				/>
				<div class="form-text">
					Formatos permitidos: JPG, PNG, PDF. Tamaño máximo: 4MB
				</div>
			</div>
			
			@if (archivoSeleccionado) {
				<div class="alert alert-success">
					<p class="mb-1"><strong>Archivo seleccionado:</strong></p>
					<p class="mb-1">{{ archivoSeleccionado.name }}</p>
					<p class="mb-0">Tamaño: {{ formatearTamanoArchivo(archivoSeleccionado.size) }}</p>
				</div>
			}
			
			@if (errorArchivo) {
				<div class="alert alert-danger">
					{{ errorArchivo }}
				</div>
			}
		}
	</div>
	<div class="modal-footer">
		<button
			type="button"
			class="btn btn-secondary"
			(click)="modal.close()"
		>
			Cancelar
		</button>
		<button
			type="button"
			class="btn btn-primary"
			(click)="subirArchivoAdjunto()"
			[disabled]="!archivoSeleccionado || subiendoArchivo"
		>
			@if (subiendoArchivo) {
				<span class="spinner-border spinner-border-sm me-2" role="status"></span>
			}
			{{ pagoSeleccionado?.urlArchivo ? 'Actualizar' : 'Subir' }} Archivo
		</button>
	</div>
</ng-template>
