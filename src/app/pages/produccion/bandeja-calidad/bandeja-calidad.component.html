<div class="container-fluid mt-5" style="padding: 0px 60px;">
	<div class="card shadow-lg p-4 rounded-4">
		<button class="btn-back-rosa position-absolute" (click)="router.navigate(['/pages/produccion/bandeja-produccion'])">
			<i class="bi bi-arrow-left"></i>
			<span>Volver a Bandeja Producción</span>
		</button>

		<h2 class="mb-4 text-center">Bandeja de Calidad</h2>

		<button class="btn-forward-rosa position-absolute" (click)="router.navigate(['/pages/produccion/bandeja-envasado'])">
			<span>Siguiente: Bandeja Envasado</span>
			<i class="bi bi-arrow-right"></i>
		</button>

		<!-- Búsqueda por ID Bulk -->
		<div class="row mb-3">
			<div class="col-md-8">
				<label for="idBulkBusqueda" class="form-label">Buscar por ID Bulk:</label>
				<input 
					type="text" 
					id="idBulkBusqueda"
					class="form-control" 
					placeholder="Ingrese el ID Bulk a buscar..."
					[(ngModel)]="idBulkBusqueda"
					[disabled]="isSearching"
					(keyup.enter)="buscarPorIdBulk()"
				/>
			</div>
			<div class="col-md-4 d-flex align-items-end">
				<button 
					class="btn btn-primary"
					(click)="buscarPorIdBulk()"
					[disabled]="isSearching || !idBulkBusqueda.trim()"
				>
					<span *ngIf="isSearching" class="spinner-border spinner-border-sm me-2" role="status"></span>
					<i class="bi bi-search me-1"></i>
					{{ isSearching ? 'Buscando...' : 'Buscar' }}
				</button>
			</div>
		</div>

		<!-- Tabla de Pedidos -->
		<div class="table-responsive">
			<table class="table table-bordered align-middle mt-0">
				<thead class="table-primary">
					<tr>
						<th>
							<input
								class="form-check-input"
								type="checkbox"
								[checked]="isTodosSeleccionadosPagina()"
								(change)="toggleSeleccionTodosPagina($event)"
								
							/>
						</th>
						<th scope="col">Nombre producto</th>
	                    <th scope="col">Presentación Total</th>
						<th scope="col">Estado</th>
						<th scope="col">Personalizado</th>
						<th scope="col">pH Definido</th>
	                    <th scope="col">pH Calidad</th>
						<th scope="col">Car. Organolépticas</th>
						<th scope="col">Viscosidad</th>
						<th scope="col" style="min-width: 180px;">Acciones</th>
					</tr>
				</thead>
				<tbody>
					@if (productos.length === 0 && !isSearching) {
						<tr>
							<td colspan="10" class="text-center py-4">
								<div class="text-muted">
									<i class="bi bi-search fs-1"></i>
									<p class="mt-2">{{ idBulkBusqueda.trim() ? 'No se encontraron productos para este ID Bulk.' : 'Ingrese un ID Bulk para buscar productos en calidad.' }}</p>
								</div>
							</td>
						</tr>
					}
					@for (item of productos; track $index) {
					<tr>
						<td>
							<input
								class="form-check-input"
								type="checkbox"
								[checked]="isSeleccionado(item, item.phCalidadPromedio, item.phDefinidoMin, item.phDefinidoMax)"
								(change)="
									toggleSeleccionIndividual(
										item,
										$event
									)
								"
								[disabled]="
									(tipoEnvio === 1 && (
										item.phCalidadPromedio === null ||
										item.phCalidadPromedio === 0 ||
										item.phCalidadPromedio < item.phDefinidoMin ||
										item.phCalidadPromedio > item.phDefinidoMax
									)) ||
									(tipoEnvio === 0 && !(
										item.phCalidadPromedio === null ||
										item.phCalidadPromedio === 0 ||
										item.phCalidadPromedio < item.phDefinidoMin ||
										item.phCalidadPromedio > item.phDefinidoMax
									))
								"
							/>
						</td>
						<td style="min-width: 200px;">{{getItemNombre(item)}}</td>
						<td style="min-width: 120px;">{{getItemPresentacion(item)}}</td>
						<td style="min-width: 100px;">{{item.estadoProducto}}</td>
						<td style="min-width: 100px;">
	                        <span>{{item.personalizado ? 'Sí' : 'No'}}</span>
	                    </td>
	                    <td style="min-width: 120px;">{{item.phDefinidoMin}} - {{item.phDefinidoMax}}</td>
	                    <td style="min-width: 120px;">
							<input
								type="number"
								class="form-control form-control-sm"
								min="1"
								[value]="item.phCalidadPromedio" 
	              				(input)="changeCalidadFields(item, $event, 'phCalidadPromedio')" 
							/>
						</td>
						<td style="min-width: 180px;">
							<input
								type="text"
								class="form-control form-control-sm"
								maxlength="25"
								[value]="item.carOrganolepticasCalidad || ''" 
	              				(input)="changeCalidadFields(item, $event, 'carOrganolepticasCalidad')" 
								placeholder="Características organolépticas"
							/>
						</td>
						<td style="min-width: 120px;">
							<input
								type="text"
								class="form-control form-control-sm"
								maxlength="25"
								[value]="item.viscosidadCalidad || ''" 
	              				(input)="changeCalidadFields(item, $event, 'viscosidadCalidad')" 
								placeholder="Viscosidad"
							/>
						</td>
						<td style="min-width: 180px;">
							<button 
								class="btn btn-info me-2" 
								[disabled]="
									item.phCalidadPromedio === null ||
									item.phCalidadPromedio === 0 ||
									item.phCalidadPromedio < item.phDefinidoMin ||
									item.phCalidadPromedio > item.phDefinidoMax
								"
								(click)="enviarEnvasado(item)"
								ngbTooltip="Enviar producto a envasado"
								placement="top"
							>
								<i class="bi bi-send"></i>
							</button>
							<button 
								class="btn btn-dark me-2" 
								(click)="getInformacionCompleta(item)" 
								ngbTooltip="Ver información completa del producto"
								placement="top"
							>
								<i class="bi bi-journal-text"></i>
							</button>
							<button 
								class="btn btn-danger me-2" 
								(click)="regresarAProduccion(item)" 
								[disabled]="
									!(item.phCalidadPromedio === null ||
									item.phCalidadPromedio === 0 ||
									item.phCalidadPromedio < item.phDefinidoMin ||
									item.phCalidadPromedio > item.phDefinidoMax)
								"
								ngbTooltip="Regresar producto a producción"
								placement="top"
							>
								<i class="bi bi-backspace"></i>
							</button>
						</td>
					</tr>
					}
				</tbody>
			</table>
		</div>

		@if (productos.length > 0) {
		<div class="d-flex justify-content-between p-2">
			<ngb-pagination
				[collectionSize]="collectionSize"
				[(page)]="page"
				[pageSize]="pageSize"
				(pageChange)="refreshProductos()"
				class="pagination-rosa"
			>
			</ngb-pagination>

			<select class="form-select" style="width: auto" [(ngModel)]="pageSize" (ngModelChange)="refreshProductos()">
				<option [ngValue]="5">5 items</option>
				<option [ngValue]="10">10 items</option>
				<option [ngValue]="15">15 items</option>
			</select>
		</div>

		<div class="d-flex justify-content-center align-items-center mb-4">
			<div class="container-fluid">
				<div class="row">
					<div class="col-2">
						<label for="">Acción masiva</label>
					</div>
				</div>
				<div class="row mt-2">
					<div class="col-2">
						<select [(ngModel)]="tipoEnvio" name="tipoEnvio" class="form-select" style="width: 100%">
							<option [ngValue]="0">Devolver a Prod.</option>
							<option [ngValue]="1">Enviar a Envasado</option>
						</select>
					</div>
					<div class="col-2">
						<button class="btn btn-dark me-2" (click)="enviarMasivo()" [disabled]="isLoading">
						<i class="bi bi-send"></i>
					</button>
					</div>
				</div>
			</div>
		</div>
		}

		<!-- <div class="d-flex justify-content-center align-items-center mb-4">
			@if (lstProductosSeleccionados.length > 0) {
				<button class="btn btn-dark me-2" (click)="enviarProduccionMasivo()">Enviar a Producción</button>
			}
			<button class="btn btn-primary me-2" (click)="router.navigate(['/pages/atencion-cliente/registro-pedido'])">Nuevo Pedido</button>
		</div> -->
	</div>
</div>


<ng-template #informacionCompleta let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Información Completa del Producto</h4>
		<button
			type="button"
			class="btn-close"
			aria-label="Close"
			(click)="modal.dismiss('Cross click')"
		></button>
	</div>
	<div class="modal-body">
		<form>
			<!-- Información del producto/preparado magistral -->
			<ng-container *ngIf="procedimientoData.productoMaestro">
				<!-- Es un producto normal -->
				<span class="mb-2"><span style="font-weight: bold;">Nombre Producto:</span> {{procedimientoData.productoMaestro.nombre}}</span>
				<br>
				<span class="mb-2"><span style="font-weight: bold;">Descripción:</span> {{procedimientoData.productoMaestro.descripcion}}</span>
			</ng-container>
			
			<ng-container *ngIf="procedimientoData.preparadoMagistral">
				<!-- Es un preparado magistral -->
				<span class="mb-2"><span style="font-weight: bold;">Nombre Preparado:</span> {{procedimientoData.preparadoMagistral.nombre}}</span>
				<br>
				<span class="mb-2"><span style="font-weight: bold;">Descripción:</span> {{procedimientoData.preparadoMagistral.descripcion}}</span>
			</ng-container>
			<hr>

			<!-- Sección de Cálculo de Ingredientes -->
			<div class="mb-4">
				<h5 class="text-primary">Ingredientes</h5>
				
				<table class="table table-bordered">
					<thead class="table-light">
						<tr>
							<th>Ingrediente</th>
							<th>Cálculo</th>
							<th>Cantidad (%)</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngFor="let ingrediente of procedimientoData.ingredientes">
							<td>{{ ingrediente.materiaPrima.nombre }}</td>
							<td>{{ (ingrediente.cantidad / 100) * getPresentacionTotal() }}</td>
							<td>{{ ingrediente.cantidad }} %</td>
						</tr>
					</tbody>
				</table>
			</div>

			<hr>

			<!-- Sección de Hoja de Procedimiento -->
			<div class="mb-4">
				<h4 style="text-align: center;" class="text-success">MODUS OPERANDI</h4>
				<h5 class="text-primary">Procedimiento</h5>

				<table class="table table-bordered">
					<thead class="table-light">
						<tr>
							<th>Orden</th>
							<th>Procedimiento</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngFor="let procedimiento of procedimientoData.procedimientos">
							<td>{{ procedimiento.orden }}</td>
							<td>{{ procedimiento.descripcion }}</td>
						</tr>
					</tbody>
				</table>

				<div class="row">
					<div class="col-md-6">
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Elementos de Seguridad Personal</label>
							<input type="text" class="form-control" [value]="procedimientoData.elementosSeguridadPersonal" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Utillaje</label>
							<input type="text" class="form-control" [value]="procedimientoData.utillaje" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Control de Calidad</label>
							<input type="text" class="form-control" [value]="procedimientoData.controlCalidad" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Tipo de Envase</label>
							<input type="text" class="form-control" [value]="procedimientoData.tipoEnvase" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Color de Etiqueta</label>
							<input type="text" class="form-control" [value]="procedimientoData.colorEtiqueta" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Indicaciones Posología</label>
							<input type="text" class="form-control" [value]="procedimientoData.indicacionesPosologia" readonly>
						</div>
					</div>
					<div class="col-md-6">
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Conservación</label>
							<input type="text" class="form-control" [value]="procedimientoData.conservacion" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Reacciones Adversas</label>
							<input type="text" class="form-control" [value]="procedimientoData.reaccionesAdversas" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Precauciones y Contraindicaciones</label>
							<input type="text" class="form-control" [value]="procedimientoData.precaucionesContraindicaciones" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Observaciones</label>
							<input type="text" class="form-control" [value]="procedimientoData.observaciones" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Bibliografía</label>
							<input type="text" class="form-control" [value]="procedimientoData.bibliografia" readonly>
						</div>
					</div>
				</div>
			</div>
		</form>
	</div>
</ng-template>

<ng-template #nota let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Agregar nota</h4>
		<button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
	</div>
	<div class="modal-body">
        <span style="font-weight: bold;">Pedido:</span> {{idPedidoNota}}<br>
        <span style="font-weight: bold;">Producto:</span> {{idProductoNota}}<br>
		<form>
			<div class="mt-3">
				<label for="nota">Nota</label>
				<textarea [(ngModel)]="observacionNota" name="nota" id="nota" class="form-control"></textarea>
			</div>
		</form>
	</div>
	<div class="modal-footer">
		<button 
			type="button" 
			class="btn btn-outline-dark" 
			(click)="saveObservacion();"
			ngbTooltip="Guardar observación del producto"
			placement="top"
		>
			Guardar
		</button>
	</div>
</ng-template>

<ng-template #successTpl>Campos de calidad actualizados correctamente.</ng-template>
<app-toasts aria-live="polite" aria-atomic="true"></app-toasts>