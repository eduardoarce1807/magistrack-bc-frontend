<div class="container-fluid mt-5" style="padding: 0px 60px">
	<div class="card shadow-lg p-4 rounded-4">
		<button class="btn-back-rosa position-absolute" (click)="router.navigate(['/pages/produccion/bandeja-envasado'])">
			<i class="bi bi-arrow-left"></i>
			<span>Volver a Bandeja Envasado</span>
		</button>

		<h2 class="mb-4 text-center">Bandeja de Etiquetado</h2>

		<button class="btn-forward-rosa position-absolute" (click)="router.navigate(['/pages/produccion/bandeja-despacho'])">
			<span>Siguiente: Bandeja Despacho</span>
			<i class="bi bi-arrow-right"></i>
		</button>

		<!-- Búsqueda por ID Producto -->
		<div class="row mb-3">
			<div class="col-md-8">
				<label for="idProductoBusqueda" class="form-label">Buscar por ID Producto:</label>
				<input 
					type="text" 
					id="idProductoBusqueda"
					class="form-control" 
					placeholder="Ingrese el ID Producto a buscar..."
					[(ngModel)]="idProductoBusqueda"
					[disabled]="isSearching"
					(keyup.enter)="buscarPorIdProducto()"
				/>
			</div>
			<div class="col-md-4 d-flex align-items-end">
				<button 
					class="btn btn-primary"
					(click)="buscarPorIdProducto()"
					[disabled]="isSearching || !idProductoBusqueda.trim()"
				>
					<span *ngIf="isSearching" class="spinner-border spinner-border-sm me-2" role="status"></span>
					<i class="bi bi-search me-1"></i>
					{{ isSearching ? 'Buscando...' : 'Buscar' }}
				</button>
			</div>
		</div>

		<!-- Tabla de Pedidos -->
		<div class="table-responsive">
			<table class="table table-bordered align-middle mt-0">
				<thead class="table-primary">
					<tr>
						<!-- <th>
							<input
								class="form-check-input"
								type="checkbox"
								[checked]="isTodosSeleccionadosPagina()"
								(change)="toggleSeleccionTodosPagina($event)"
							/>
						</th> -->
						<th scope="col" style="min-width: 120px;">Código producto</th>
						<th scope="col" style="min-width: 200px;">Nombre producto</th>
						<th scope="col" style="min-width: 150px;">Presentación</th>
						<th scope="col" style="min-width: 100px;">Cantidad</th>
						<th scope="col" style="min-width: 100px;">Estado</th>
						<th scope="col" style="min-width: 120px;">Personalizado</th>
						<th scope="col" style="min-width: 150px;">Acciones</th>
					</tr>
				</thead>
			<tbody>
				@if (productos.length === 0 && !isSearching) {
					<tr>
						<td colspan="7" class="text-center py-4">
							<div class="text-muted">
								<i class="bi bi-search fs-1"></i>
								<p class="mt-2">{{ idProductoBusqueda.trim() ? 'No se encontraron productos para este ID Producto.' : 'Ingrese un ID Producto para buscar productos en etiquetado.' }}</p>
							</div>
						</td>
					</tr>
				}
				@for (item of productos; track $index) {
				<tr>
					<!-- <td>
						<input
							class="form-check-input"
							type="checkbox"
							[checked]="
								isSeleccionado(
									item.idProducto,
									item.idPedido
								)
							"
							(change)="
								toggleSeleccionIndividual(
									item.idProducto,
									item.idPedido,
									$event
								)
							"
						/>
					</td> -->
					<td>{{ item.id }}</td>
					<td>{{ item.nombre }}</td>
					<td>{{ item.presentacion }} {{ item.tipoPresentacion }}</td>
					<td>{{ item.cantidad }}</td>
					<td>{{ item.estadoProducto }}</td>
					<td>
						<span>{{ item.personalizado ? "Sí" : "No" }}</span>
					</td>
					<td>
						<button
							class="btn btn-info me-2"
							(click)="enviarDespachoDirecto(item)"
							ngbTooltip="Enviar producto directamente a despacho"
							placement="top"
						>
							<i class="bi bi-send"></i>
						</button>
						<button
							class="btn btn-secondary me-2"
							(click)="openModalNota(item, nota)"
							ngbTooltip="Agregar observaciones al producto"
							placement="top"
						>
							<i class="bi bi-stickies"></i>
						</button>
						<button
							class="btn btn-primary"
							(click)="openModalEtiqueta(item, etiquetaModal)"
							ngbTooltip="Ver etiqueta"
							placement="top"
						>
							<i class="bi bi-tag"></i>
						</button>
					</td>
				</tr>
				}
			</tbody>
		</table>
		</div>

		<div class="d-flex justify-content-between p-2">
			<ngb-pagination
				[collectionSize]="collectionSize"
				[(page)]="page"
				[pageSize]="pageSize"
				(pageChange)="refreshProductos()"
				class="pagination-rosa"
			>
			</ngb-pagination>

			<select
				class="form-select"
				style="width: auto"
				[(ngModel)]="pageSize"
				(ngModelChange)="refreshProductos()"
			>
				<option [ngValue]="5">5 items</option>
				<option [ngValue]="10">10 items</option>
				<option [ngValue]="15">15 items</option>
			</select>
		</div>

		<!-- <div class="d-flex justify-content-start align-items-start mb-4">
			<div class="container-fluid">
				<div class="row">
					<div class="col-2">
						<label for="">Acción masiva</label>
					</div>
				</div>
                <div class="row mt-2">
                    <div class="col-2">
                        <select
                            [(ngModel)]="tipoEnvio"
                            name="tipoEnvio"
                            class="form-select"
                            style="width: 100%"
                        >
                            <option [ngValue]="0">Enviar a despacho</option>
                        </select>
                    </div>
                    <div class="col-2">
                        <button
                            class="btn btn-dark me-2"
                            (click)="enviarMasivo()"
                        >
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
			</div>
		</div> -->

	</div>
</div>

<ng-template #procedimiento let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Hoja de Procedimiento</h4>
		<button
			type="button"
			class="btn-close"
			aria-label="Close"
			(click)="modal.dismiss('Cross click')"
		></button>
	</div>
	<div class="modal-body">
		<form>
			<span class="mb-2"><span style="font-weight: bold;">ID Producto:</span> {{procedimientoData.producto.idProducto}}</span><br>
			<span class="mb-2"><span style="font-weight: bold;">Nombre Producto:</span> {{procedimientoData.producto.nombre}}</span>
			<hr>

			<h5>Ingredientes</h5>

			<table class="table table-bordered">
				<thead>
					<tr>
						<th>Ingrediente</th>
						<th>Cantidad (100g)</th>
						<th>Total</th>
					</tr>
				</thead>
				<tbody>
					<tr *ngFor="let ingrediente of procedimientoData.ingredientes">
						<td>{{ ingrediente.materiaPrima.nombre }}</td>
						<td>{{ ingrediente.cantidad }}</td>
						<td>{{ ingrediente.cantidad * 10 }}</td>
					</tr>
				</tbody>
			</table>

			<h4 style="text-align: center;">MODUS OPERANDI</h4>
			<h5>Procedimiento</h5>

			<table class="table table-bordered">
				<thead>
					<tr>
						<th>Orden</th>
						<th>Procedimiento</th>
					</tr>
				</thead>
				<tbody>
					<tr *ngFor="let procedimiento of procedimientoData.procedimientos">
						<td>{{ procedimiento.orden }}</td>
						<td>{{ procedimiento.descripcion }}</td>
					</tr>
				</tbody>
			</table>

			<div class="mb-2">
				<label class="form-label" style="font-weight: bold;">Elementos de Seguridad Personal</label>
				<input type="text" class="form-control" [value]="procedimientoData.elementosSeguridadPersonal" readonly>
			</div>
			<div class="mb-2">
				<label class="form-label" style="font-weight: bold;">Utillaje</label>
				<input type="text" class="form-control" [value]="procedimientoData.utillaje" readonly>
			</div>
			<div class="mb-2">
				<label class="form-label" style="font-weight: bold;">Control de Calidad</label>
				<input type="text" class="form-control" [value]="procedimientoData.controlCalidad" readonly>
			</div>
			<div class="mb-2">
				<label class="form-label" style="font-weight: bold;">Tipo de Envase</label>
				<input type="text" class="form-control" [value]="procedimientoData.tipoEnvase" readonly>
			</div>
			<div class="mb-2">
				<label class="form-label" style="font-weight: bold;">Color de Etiqueta</label>
				<input type="text" class="form-control" [value]="procedimientoData.colorEtiqueta" readonly>
			</div>
			<div class="mb-2">
				<label class="form-label" style="font-weight: bold;">Indicaciones Posología</label>
				<input type="text" class="form-control" [value]="procedimientoData.indicacionesPosologia" readonly>
			</div>
			<div class="mb-2">
				<label class="form-label" style="font-weight: bold;">Conservación</label>
				<input type="text" class="form-control" [value]="procedimientoData.conservacion" readonly>
			</div>
			<div class="mb-2">
				<label class="form-label" style="font-weight: bold;">Reacciones Adversas</label>
				<input type="text" class="form-control" [value]="procedimientoData.reaccionesAdversas" readonly>
			</div>
			<div class="mb-2">
				<label class="form-label" style="font-weight: bold;">Precauciones y Contraindicaciones</label>
				<input type="text" class="form-control" [value]="procedimientoData.precaucionesContraindicaciones" readonly>
			</div>
			<div class="mb-2">
				<label class="form-label" style="font-weight: bold;">Observaciones</label>
				<input type="text" class="form-control" [value]="procedimientoData.observaciones" readonly>
			</div>
			<div class="mb-2">
				<label class="form-label" style="font-weight: bold;">Bibliografía</label>
				<input type="text" class="form-control" [value]="procedimientoData.bibliografia" readonly>
			</div>
		</form>
	</div>
</ng-template>

<ng-template #validarProductoModal let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Validar información de producto</h4>
		<button
			type="button"
			class="btn-close"
			aria-label="Close"
			(click)="codigoProductoValidar = '';modal.dismiss('Cross click')"
		></button>
	</div>
	<div class="modal-body">
		<div style="width: 100%">
            <div class="row">
                <div class="col-12">
                    <label for="codigoProducto">Código Producto</label>
                    <input
                        type="text"
                        class="form-control"
                        id="codigoProducto"
                        [(ngModel)]="codigoProductoValidar"
                        name="codigoProductoValidar"
                    />
                </div>
            </div>
		</div>
	</div>
    <div class="modal-footer">
        <button
            type="button"
            class="btn btn-dark"
            (click)="validarProducto()"
            ngbTooltip="Validar el código de producto ingresado"
            placement="top"
        >
            Validar
        </button>
    </div>
</ng-template>

<ng-template #datosProductoValidar let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">Datos del Producto Validado</h4>
        <button
            type="button"
            class="btn-close"
            aria-label="Close"
            (click)="modal.dismiss('Cross click')"
        ></button>
    </div>
    <div class="modal-body">
        <div class="row mb-3">
            <div class="col-12">
                <label for="idProductoValidado">Código del Producto</label>
                <input
                    type="text"
                    class="form-control"
                    id="idProductoValidado"
                    [(ngModel)]="idProductoValidado"
                    name="idProductoValidado"
                    readonly
                />
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <label for="nombreProductoValidado">Nombre del Producto</label>
                <input
                    type="text"
                    class="form-control"
                    id="nombreProductoValidado"
                    [(ngModel)]="nombreProductoValidado"
                    name="nombreProductoValidado"
                    readonly
                />
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <label for="descripcionProductoValidado">Descripción</label>
                <textarea
                    class="form-control"
                    id="descripcionProductoValidado"
                    [(ngModel)]="descripcionProductoValidado"
                    name="descripcionProductoValidado"
                    readonly
                ></textarea>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <label for="presentacionProductoValidado">Presentación</label>
                <input
                    type="text"
                    class="form-control"
                    id="presentacionProductoValidado"
                    [(ngModel)]="presentacionProductoValidado"
                    name="presentacionProductoValidado"
                    readonly
                />
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button
            type="button"
            class="btn btn-danger"
            (click)="openModal(validarProductoModal)"
            ngbTooltip="Regresar a la validación de código"
            placement="top"
        >
            Regresar
        </button>
        <button
            type="button"
            class="btn btn-success"
            (click)="enviarDespacho({ idProducto: idProductoValidar, idPedido: idPedidoValidar })"
            ngbTooltip="Confirmar validación y enviar a despacho"
            placement="top"
        >
            Validar y Enviar
        </button>
    </div>
</ng-template>

<ng-template #nota let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Agregar nota</h4>
		<button
			type="button"
			class="btn-close"
			aria-label="Close"
			(click)="modal.dismiss('Cross click')"
		></button>
	</div>
	<div class="modal-body">
		<span style="font-weight: bold">Pedido:</span> {{ idPedidoNota }}<br />
		<span style="font-weight: bold">Producto:</span> {{ idProductoNota
		}}<br />
		<form>
			<div class="mt-3">
				<label for="nota">Nota</label>
				<textarea
					[(ngModel)]="observacionNota"
					name="nota"
					id="nota"
					class="form-control"
				></textarea>
			</div>
		</form>
	</div>
	<div class="modal-footer">
		<button
			type="button"
			class="btn btn-outline-dark"
			(click)="saveObservacion()"
			ngbTooltip="Guardar observación del producto"
			placement="top"
		>
			Guardar
		</button>
	</div>
</ng-template>

<ng-template #etiquetaModal let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Etiqueta del Producto</h4>
		<button
			type="button"
			class="btn-close"
			aria-label="Close"
			(click)="modal.dismiss('Cross click')"
		></button>
	</div>
	<div class="modal-body text-center">
		<div class="mb-3">
			<p><strong>Código:</strong> {{ productoEtiqueta?.id }}</p>
			<p><strong>Nombre:</strong> {{ productoEtiqueta?.nombre }}</p>
			<p><strong>Presentación:</strong> {{ productoEtiqueta?.presentacion }} {{ productoEtiqueta?.tipoPresentacion }}</p>
		</div>
		<div class="d-flex justify-content-center">
			<img 
				src="assets/img/etiqueta-generica.svg" 
				alt="Etiqueta del producto" 
				class="img-fluid"
				style="max-width: 500px; max-height: 500px; border: 1px solid #ddd; border-radius: 8px;"
			/>
		</div>
		<div class="mt-3">
			<small class="text-muted">Imagen de referencia - Etiqueta genérica para productos dermatológicos</small>
		</div>
	</div>
	<div class="modal-footer">
		<button
			type="button"
			class="btn btn-primary me-2"
			(click)="imprimirEtiqueta()"
			ngbTooltip="Imprimir etiqueta"
			placement="top"
		>
			<i class="bi bi-printer"></i> Imprimir
		</button>
		<button
			type="button"
			class="btn btn-secondary"
			(click)="modal.close()"
		>
			Cerrar
		</button>
	</div>
</ng-template>
