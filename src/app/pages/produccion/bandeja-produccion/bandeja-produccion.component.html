<div class="container-fluid mt-5" style="padding: 0px 60px">
	<div class="card shadow-lg p-4 rounded-4">

		<button 
			class="btn-back-rosa position-absolute" 
			(click)="router.navigate(['/pages/atencion-cliente/bandeja-pedidos-administrador'])"
			ngbTooltip="Ir a bandeja de pedidos"
			placement="top"
		>
			<i class="bi bi-arrow-left"></i>
			<span>Volver a Bandeja de Pedidos</span>
		</button>

		<h2 class="mb-4 text-center">Hoja de Producción</h2>

		<button class="btn-forward-rosa position-absolute" (click)="router.navigate(['/pages/produccion/bandeja-calidad'])">
			<span>Siguiente: Bandeja Calidad</span>
			<i class="bi bi-arrow-right"></i>
		</button>

		<!-- Tabla de Pedidos -->
		<div class="table-responsive">
			<table class="table table-bordered align-middle mt-0">
				<thead class="table-primary">
					<tr>
						<th>
							<input
								class="form-check-input"
								type="checkbox"
								[checked]="isTodosSeleccionadosPagina()"
								(change)="toggleSeleccionTodosPagina($event)"
								
							/>
						</th>
						<th scope="col" style="min-width: 200px;">Nombre producto</th>
						<th scope="col" style="min-width: 150px;">Presentación Total</th>
						<th scope="col" style="min-width: 100px;">Estado</th>
						<th scope="col" style="min-width: 120px;">Personalizado</th>
						<th scope="col" style="min-width: 200px;">Acciones</th>
					</tr>
				</thead>
				<tbody>
					@for (item of productos; track $index) {
					<tr [ngClass]="{
							'table-warning': item.idEstadoProducto == 2,
							'table-success': item.idEstadoProducto == 3
						}">
						<td>
							<input
								class="form-check-input"
							type="checkbox"
							[checked]="isSeleccionado(getItemId(item))"
							(change)="
								toggleSeleccionIndividual(
									getItemId(item),
									$event
								)
							"
							[disabled]="(tipoEnvio == 0 && item.idEstadoProducto == 3) || (tipoEnvio == 1 && item.idEstadoProducto == 2)"
						/>
					</td>

					<td>{{ getItemNombre(item) }}</td>
					<td>{{ getItemPresentacion(item) }}</td>
					<td>{{ item.estadoProducto }}</td>
					<td>
						<span>{{ item.personalizado ? "Sí" : "No" }}</span>
					</td>
					<td>
						<button
							[disabled]="item.idEstadoProducto == 3"
							class="btn btn-primary me-2"
							(click)="recibirProducto(item)"
							ngbTooltip="Recibir producto en producción"
							placement="top"
						>
							<i class="bi bi-download"></i>
						</button>
						<button
							class="btn btn-dark me-2"
							(click)="getInformacionCompleta(item)"
							ngbTooltip="Ver información completa del producto"
							placement="top"
						>
							<i class="bi bi-journal-text"></i>
						</button>
						<button
							*ngIf="item.idEstadoProducto == 3"
							class="btn btn-warning me-2"
							(click)="openModalCodigoBarraIndividual(item)"
							ngbTooltip="Imprimir código de barras del producto"
							placement="top"
						>
							<i class="bi bi-upc-scan"></i>
						</button>
						<button
							[disabled]="item.idEstadoProducto == 2"
							class="btn btn-info me-2"
							(click)="enviarCalidad(item)"
							ngbTooltip="Enviar producto a calidad"
							placement="top"
						>
							<i class="bi bi-send"></i>
						</button>
					</td>
				</tr>
				}
			</tbody>
		</table>
		</div>

		<div class="d-flex justify-content-between p-2">
			<ngb-pagination
				[collectionSize]="collectionSize"
				[(page)]="page"
				[pageSize]="pageSize"
				(pageChange)="refreshProductos()"
				class="pagination-rosa"
			>
			</ngb-pagination>

			<select
				class="form-select"
				style="width: auto"
				[(ngModel)]="pageSize"
				(ngModelChange)="refreshProductos()"
			>
				<option [ngValue]="5">5 items</option>
				<option [ngValue]="10">10 items</option>
				<option [ngValue]="15">15 items</option>
			</select>
		</div>

		<div class="d-flex justify-content-center align-items-center mb-4">
			<div class="container-fluid">
				<div class="row">
					<div class="col-2">
						<label for="">Acción masiva</label>
					</div>
				</div>
				<div class="row mt-2">
					<div class="col-2">
						<select (change)="lstProductosSeleccionados = []" [(ngModel)]="tipoEnvio" name="tipoEnvio" class="form-select" style="width: 100%">
							<option [ngValue]="0">Recibir</option>
							<option [ngValue]="1">Enviar a Calidad</option>
						</select>
					</div>
					<div class="col-2">
						<button class="btn btn-dark me-2" (click)="enviarMasivo()">
						<i class="bi bi-send"></i>
					</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<ng-template #informacionCompleta let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Información Completa del Producto</h4>
		<button
			type="button"
			class="btn-close"
			aria-label="Close"
			(click)="modal.dismiss('Cross click')"
		></button>
	</div>
	<div class="modal-body">
		<form>
			<!-- Información del item (producto o preparado magistral) -->
			<div *ngIf="procedimientoData?.productoMaestro; else preparadoMagistralInfo">
				<!-- Información para productos normales -->
				<span class="mb-2"><span style="font-weight: bold;">Nombre Producto:</span> {{procedimientoData.productoMaestro.nombre}}</span>
				<br>
				<span class="mb-2"><span style="font-weight: bold;">Descripción:</span> {{procedimientoData.productoMaestro.descripcion}}</span>
			</div>
			<ng-template #preparadoMagistralInfo>
				<!-- Información para preparados magistrales -->
				<span class="mb-2"><span style="font-weight: bold;">Nombre Preparado:</span> {{procedimientoData.preparadoMagistral?.nombre}}</span>
				<br>
				<span class="mb-2"><span style="font-weight: bold;">Descripción:</span> {{procedimientoData.preparadoMagistral?.descripcion}}</span>
			</ng-template>
			<hr>

			<!-- Sección de Cálculo de Ingredientes -->
			<div class="mb-4">
				<h5 class="text-primary">Ingredientes</h5>
				
				<table class="table table-bordered">
					<thead class="table-light">
						<tr>
							<th>Ingrediente</th>
							<th>Cálculo</th>
							<th>Cantidad (%)</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngFor="let ingrediente of procedimientoData.ingredientes">
							<td>{{ ingrediente.materiaPrima.nombre }}</td>
							<td>{{ (ingrediente.cantidad / 100) * getPresentacionTotal() }}</td>
							<td>{{ ingrediente.cantidad }} %</td>
						</tr>
					</tbody>
				</table>
			</div>

			<hr>

			<!-- Sección de Hoja de Procedimiento -->
			<div class="mb-4">
				<h4 style="text-align: center;" class="text-success">MODUS OPERANDI</h4>
				<h5 class="text-primary">Procedimiento</h5>

				<table class="table table-bordered">
					<thead class="table-light">
						<tr>
							<th>Orden</th>
							<th>Procedimiento</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngFor="let procedimiento of procedimientoData.procedimientos">
							<td>{{ procedimiento.orden }}</td>
							<td>{{ procedimiento.descripcion }}</td>
						</tr>
					</tbody>
				</table>

				<div class="row">
					<div class="col-md-6">
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Elementos de Seguridad Personal</label>
							<input type="text" class="form-control" [value]="procedimientoData.elementosSeguridadPersonal" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Utillaje</label>
							<input type="text" class="form-control" [value]="procedimientoData.utillaje" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Control de Calidad</label>
							<input type="text" class="form-control" [value]="procedimientoData.controlCalidad" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Tipo de Envase</label>
							<input type="text" class="form-control" [value]="procedimientoData.tipoEnvase" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Color de Etiqueta</label>
							<input type="text" class="form-control" [value]="procedimientoData.colorEtiqueta" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Indicaciones Posología</label>
							<input type="text" class="form-control" [value]="procedimientoData.indicacionesPosologia" readonly>
						</div>
					</div>
					<div class="col-md-6">
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Conservación</label>
							<input type="text" class="form-control" [value]="procedimientoData.conservacion" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Reacciones Adversas</label>
							<input type="text" class="form-control" [value]="procedimientoData.reaccionesAdversas" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Precauciones y Contraindicaciones</label>
							<input type="text" class="form-control" [value]="procedimientoData.precaucionesContraindicaciones" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Observaciones</label>
							<input type="text" class="form-control" [value]="procedimientoData.observaciones" readonly>
						</div>
						<div class="mb-2">
							<label class="form-label" style="font-weight: bold;">Bibliografía</label>
							<input type="text" class="form-control" [value]="procedimientoData.bibliografia" readonly>
						</div>
					</div>
				</div>
			</div>
		</form>
	</div>
</ng-template>

<ng-template #codigoBarraIndividual let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Código de Barras</h4>
		<button
			type="button"
			class="btn-close"
			aria-label="Close"
			(click)="modal.dismiss('Cross click')"
		></button>
	</div>
	<div class="modal-body">
		<div class="text-center">
			<p><strong>{{ getItemTipo(itemCodigoBarras) }}:</strong> {{ getItemNombre(itemCodigoBarras) || 'N/A' }}</p>
			<p><strong>ID Bulk:</strong> {{ itemCodigoBarras?.idBulk || 'N/A' }}</p>
			<hr>
			<div id="barcodeIndividualDiv" class="d-flex justify-content-center">
				<div style="border: 1px dashed #ccc; padding: 20px;">
					<svg id="barcode-individual" class="barcode"></svg>
				</div>
			</div>
		</div>
		<div class="d-flex justify-content-center mt-3">
			<button class="btn btn-primary" (click)="imprimirCodigoBarraIndividual('barcodeIndividualDiv')">
				<i class="bi bi-printer-fill"></i> Imprimir
			</button>
		</div>
	</div>
</ng-template>

<ng-template #codigoBarraMasivo let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Códigos de Barras - Impresión Masiva</h4>
		<button
			type="button"
			class="btn-close"
			aria-label="Close"
			(click)="modal.dismiss('Cross click')"
		></button>
	</div>
	<div class="modal-body">
		<div class="text-center">
			<p><strong>Productos recibidos en producción ({{ productosCodigoBarrasMasivo.length }})</strong></p>
			<hr>
			<div id="barcodesMasivoDiv">
				<div *ngFor="let producto of productosCodigoBarrasMasivo; let i = index" 
					 class="mb-4 d-flex justify-content-center">
					<div style="border: 1px dashed #ccc; padding: 20px; text-align: center;">
						<p style="margin: 0 0 10px 0; font-weight: bold;">{{ producto.nombreProducto }}</p>
						<p style="margin: 0 0 10px 0; font-size: 12px;">Bulk: {{ producto.idBulk }}</p>
						<div class="d-flex justify-content-center">
							<svg [id]="'barcode-masivo-' + i" class="barcode"></svg>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="d-flex justify-content-center mt-3">
			<button class="btn btn-primary" (click)="imprimirCodigoBarraMasivo('barcodesMasivoDiv')">
				<i class="bi bi-printer-fill"></i> Imprimir Todos
			</button>
		</div>
	</div>
</ng-template>

<ng-template #nota let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Agregar nota</h4>
		<button
			type="button"
			class="btn-close"
			aria-label="Close"
			(click)="modal.dismiss('Cross click')"
		></button>
	</div>
	<div class="modal-body">
		<span style="font-weight: bold">Pedido:</span> {{ idPedidoNota }}<br />
		<span style="font-weight: bold">Producto:</span> {{ idProductoNota
		}}<br />
		<form>
			<div class="mt-3">
				<label for="nota">Nota</label>
				<textarea
					[(ngModel)]="observacion"
					name="nota"
					id="nota"
					class="form-control"
				></textarea>
			</div>
		</form>
	</div>
	<div class="modal-footer">
		<button
			type="button"
			class="btn btn-outline-dark"
			(click)="saveObservacion()"
		>
			Guardar
		</button>
	</div>
</ng-template>

<!-- Modal para asignar usuario -->
<ng-template #asignarUsuarioModal let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Asignar Usuario al Bulk</h4>
		<button
			type="button"
			class="btn-close"
			aria-label="Close"
			(click)="modal.dismiss('Cross click')">
		</button>
	</div>
	<div class="modal-body">
		<div *ngIf="itemParaAsignar">
			<div class="mb-4">
				<h6 class="text-muted mb-3">Información del Producto:</h6>
				<div class="row">
					<div class="col-md-6">
						<p><strong>Tipo:</strong> {{ getItemTipo(itemParaAsignar) }}</p>
						<p><strong>Nombre:</strong> {{ getItemNombre(itemParaAsignar) }}</p>
					</div>
					<div class="col-md-6">
						<p><strong>Estado:</strong> 
							<span class="badge bg-success">En Producción</span>
						</p>
						<p><strong>Presentación:</strong> {{ getItemPresentacion(itemParaAsignar) }}</p>
					</div>
				</div>
			</div>
			
			<hr>
			
			<div class="mb-3">
				<h6 class="text-muted mb-3">Seleccionar Usuario de Producción:</h6>
				
				<div *ngIf="loadingUsuarios" class="text-center p-3">
					<div class="spinner-border text-primary" role="status">
						<span class="visually-hidden">Cargando usuarios...</span>
					</div>
					<p class="mt-2 text-muted">Cargando usuarios de producción...</p>
				</div>
				
				<div *ngIf="!loadingUsuarios && usuarios.length > 0">
					<p class="text-info mb-3">
						<i class="bi bi-info-circle me-2"></i>
						Se muestran solo los usuarios con rol de producción.
					</p>
					
					<div class="form-group">
						<label for="usuarioSelect" class="form-label">Usuario disponible:</label>
						<select 
							id="usuarioSelect"
							class="form-select" 
							[(ngModel)]="usuarioSeleccionado"
							[disabled]="loadingUsuarios">
							<option [ngValue]="null">Seleccione un usuario...</option>
							<option 
								*ngFor="let usuario of usuarios" 
								[ngValue]="usuario">
								{{ getNombreCompletoUsuario(usuario) }} - {{ usuario.rol.nombre }} ({{ usuario.usuario }})
							</option>
						</select>
					</div>
					
					<div *ngIf="usuarioSeleccionado" class="mt-3 p-3 bg-light rounded">
						<h6 class="text-success">Usuario Seleccionado:</h6>
						<p class="mb-1"><strong>Nombre:</strong> {{ getNombreCompletoUsuario(usuarioSeleccionado) }}</p>
						<p class="mb-1"><strong>Usuario:</strong> {{ usuarioSeleccionado.usuario }}</p>
						<p class="mb-1"><strong>Rol:</strong> {{ usuarioSeleccionado.rol.nombre }}</p>
						<p class="mb-0"><strong>Email:</strong> {{ usuarioSeleccionado.cliente?.correo || 'No disponible' }}</p>
					</div>
				</div>
				
				<div *ngIf="!loadingUsuarios && usuarios.length === 0" class="text-center p-4">
					<i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
					<h6 class="text-warning mt-2">No hay usuarios disponibles</h6>
					<p class="text-muted">
						No se encontraron usuarios con rol de producción disponibles.
					</p>
				</div>
			</div>
		</div>
	</div>
	<div class="modal-footer">
		<div class="d-flex justify-content-between w-100">
			<button 
				type="button"
				class="btn btn-outline-secondary"
				(click)="modal.dismiss('cancel')">
				Cancelar
			</button>
			<button 
				type="button"
				class="btn btn-success"
				[disabled]="!usuarioSeleccionado || loadingUsuarios"
				(click)="asignarUsuarioSeleccionado()">
				<i class="bi bi-user-plus me-2"></i>
				Asignar Usuario
			</button>
		</div>
	</div>
</ng-template>
