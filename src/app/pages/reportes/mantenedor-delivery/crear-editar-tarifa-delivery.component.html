<div class="container-fluid">

  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="bi bi-plus-circle me-2" *ngIf="!isEditMode"></i>
            <i class="bi bi-pencil me-2" *ngIf="isEditMode"></i>
            {{ getTituloPagina() }}
          </h2>
          <p class="text-muted mb-0">
            Complete los datos para {{ isEditMode ? 'actualizar' : 'crear' }} la tarifa de delivery
          </p>
        </div>
        <div>
          <button 
            type="button" 
            class="btn btn-outline-secondary me-2" 
            (click)="volverAlListado()"
            [disabled]="guardando">
            <i class="bi bi-arrow-left me-2"></i>Volver al Listado
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Verificación de permisos -->
  <div *ngIf="!tienePermisos()" class="alert alert-warning">
    <i class="bi bi-exclamation-triangle me-2"></i>
    No tiene permisos suficientes para realizar esta acción.
  </div>

  <!-- Loading inicial -->
  <div *ngIf="cargando" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2 text-muted">Cargando datos...</p>
  </div>

  <!-- Formulario -->
  <div *ngIf="!cargando && tienePermisos()">
    <form #tarifaForm="ngForm" (ngSubmit)="guardarTarifa(tarifaForm)">

      <!-- Sección: Tipo de Regla -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-gear me-2"></i>Tipo de Regla de Delivery
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            
            <!-- Tipo de Regla -->
            <div class="col-md-8 mb-3">
              <label class="form-label">
                Tipo de Regla <span class="text-danger">*</span>
              </label>
              <select 
                class="form-select" 
                name="tipoRegla"
                [(ngModel)]="tarifa.tipoRegla"
                (change)="onTipoReglaChange()"
                required>
                <option value="">Seleccionar tipo de regla</option>
                <option 
                  *ngFor="let regla of tiposReglaOptions" 
                  [value]="regla.value">
                  {{ regla.label }} - {{ regla.descripcion }}
                </option>
              </select>
              <div class="form-text" *ngIf="tarifa.tipoRegla">
                {{ getDescripcionRegla(tarifa.tipoRegla) }}
              </div>
            </div>

            <!-- Estado -->
            <div class="col-md-4 mb-3">
              <label class="form-label">Estado</label>
              <div class="form-check form-switch simple-switch">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  name="activo"
                  [(ngModel)]="tarifa.activo"
                  id="switchActivo">
                <label class="form-check-label" for="switchActivo">
                  {{ tarifa.activo ? 'Activo' : 'Inactivo' }}
                </label>
              </div>
              <div class="form-text">
                Solo las reglas activas se aplicarán en el cálculo
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Sección: Ubicación (solo para regla específica) -->
      <div class="card mb-4" *ngIf="requiereDistrito()">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-geo-alt me-2"></i>Ubicación Específica
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            
            <!-- Departamento -->
            <div class="col-md-4 mb-3">
              <label class="form-label">
                Departamento <span class="text-danger">*</span>
                <span class="spinner-border spinner-border-sm ms-2" *ngIf="cargandoDepartamentos"></span>
              </label>
              <select 
                class="form-select" 
                name="idDepartamento"
                [(ngModel)]="tarifa.idDepartamento"
                (change)="onDepartamentoChange()"
                [required]="requiereDistrito()"
                [disabled]="cargandoDepartamentos">
                <option [value]="null">Seleccionar departamento</option>
                <option 
                  *ngFor="let departamento of departamentos" 
                  [value]="departamento.idDepartamento">
                  {{ departamento.nombre }}
                </option>
              </select>
              <div class="form-text">
                Solo Lima y Callao disponibles
              </div>
            </div>

            <!-- Provincia -->
            <div class="col-md-4 mb-3">
              <label class="form-label">
                Provincia <span class="text-danger">*</span>
                <span class="spinner-border spinner-border-sm ms-2" *ngIf="cargandoProvincias"></span>
              </label>
              <select 
                class="form-select" 
                name="idProvincia"
                [(ngModel)]="tarifa.idProvincia"
                (change)="onProvinciaChange()"
                [required]="requiereDistrito() && !!tarifa.idDepartamento"
                [disabled]="cargandoProvincias || !tarifa.idDepartamento">
                <option value="">Seleccionar provincia</option>
                <option 
                  *ngFor="let provincia of provincias" 
                  [value]="provincia.idProvincia">
                  {{ provincia.nombre }}
                </option>
              </select>
              <div class="form-text">
                Seleccione primero el departamento
              </div>
            </div>

            <!-- Distrito -->
            <div class="col-md-4 mb-3">
              <label class="form-label">
                Distrito <span class="text-danger">*</span>
                <span class="spinner-border spinner-border-sm ms-2" *ngIf="cargandoDistritos"></span>
              </label>
              <select 
                class="form-select" 
                name="idDistrito"
                [(ngModel)]="tarifa.idDistrito"
                [required]="requiereDistrito() && !!tarifa.idProvincia"
                [disabled]="cargandoDistritos || !tarifa.idProvincia">
                <option value="">Seleccionar distrito</option>
                <option 
                  *ngFor="let distrito of distritos" 
                  [value]="distrito.idDistrito">
                  {{ distrito.nombre }}
                </option>
              </select>
              <div class="form-text">
                Seleccione primero la provincia
              </div>
            </div>

          </div>

          <!-- Información de ubicación seleccionada -->
          <!-- <div class="row" *ngIf="tarifa.idDistrito">
            <div class="col-12">
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Ubicación seleccionada:</strong> 
                {{ getNombreDistrito() }}, {{ getNombreProvincia() }}, {{ getNombreDepartamento() }}
              </div>
            </div>
          </div> -->

        </div>
      </div>

      <!-- Sección: Tarifa -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-currency-dollar me-2"></i>Tarifa de Delivery
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            
            <!-- Tarifa -->
            <div class="col-md-6 mb-3">
              <label class="form-label">
                Tarifa (S/) <span class="text-danger">*</span>
              </label>
              <input 
                type="number" 
                class="form-control" 
                name="tarifa"
                [(ngModel)]="tarifa.tarifa"
                [readonly]="esEnvioGratis()"
                min="0"
                step="0.01"
                required
                placeholder="0.00">
              <div class="form-text">
                {{ esEnvioGratis() ? 'Tarifa automática para envío gratis' : 'Monto del delivery para esta regla' }}
              </div>
            </div>

            <!-- Descripción -->
            <div class="col-md-6 mb-3">
              <label class="form-label">
                Descripción
              </label>
              <textarea 
                class="form-control" 
                name="descripcion"
                [(ngModel)]="tarifa.descripcion"
                rows="3"
                placeholder="Descripción de la tarifa de delivery">
              </textarea>
              <div class="form-text">
                Descripción que aparecerá en el sistema para identificar esta regla
              </div>
            </div>

          </div>

          <!-- Información adicional -->
          <div class="row" *ngIf="tarifa.tipoRegla">
            <div class="col-12">
              <div class="bg-light p-3 rounded">
                <h6 class="mb-2">
                  <i class="bi bi-info-circle me-2"></i>Resumen de la Regla
                </h6>
                <div class="small text-muted">
                  <strong>Tipo de Regla:</strong> {{ getDescripcionRegla(tarifa.tipoRegla) }}
                  <br *ngIf="requiereDistrito() && getNombreDistrito()">
                  <strong *ngIf="requiereDistrito() && getNombreDistrito()">Ubicación:</strong> 
                  {{ getNombreDistrito() }}<span *ngIf="getNombreProvincia()">, {{ getNombreProvincia() }}</span><span *ngIf="getNombreDepartamento()">, {{ getNombreDepartamento() }}</span>
                  <br *ngIf="tarifa.descripcion">
                  <strong>Descripción:</strong> {{ tarifa.descripcion }}
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Errores de Validación -->
      <div class="alert alert-danger" *ngIf="erroresValidacion.length > 0">
        <h6 class="alert-heading">
          <i class="bi bi-exclamation-triangle me-2"></i>Errores de Validación
        </h6>
        <ul class="mb-0">
          <li *ngFor="let error of erroresValidacion">{{ error }}</li>
        </ul>
      </div>

      <!-- Botones de Acción -->
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            
            <!-- Botones izquierda -->
            <div>
              <button 
                type="button" 
                class="btn btn-outline-warning me-2"
                (click)="resetearFormulario()"
                [disabled]="guardando || cargando">
                <i class="bi bi-arrow-clockwise me-2"></i>Resetear
              </button>
              <button 
                type="button" 
                class="btn btn-outline-info"
                (click)="limpiarErrores()"
                *ngIf="erroresValidacion.length > 0">
                <i class="bi bi-x-circle me-2"></i>Limpiar Errores
              </button>
            </div>

            <!-- Botones derecha -->
            <div>
              <button 
                type="button" 
                class="btn btn-secondary me-2" 
                (click)="cancelar()"
                [disabled]="guardando">
                <i class="bi bi-x me-2"></i>Cancelar
              </button>
              <button 
                type="submit" 
                class="btn btn-success"
                [disabled]="!tarifaForm.valid || guardando">
                <span *ngIf="guardando" class="spinner-border spinner-border-sm me-2"></span>
                <i *ngIf="!guardando && !isEditMode" class="bi bi-check-circle me-2"></i>
                <i *ngIf="!guardando && isEditMode" class="bi bi-save me-2"></i>
                {{ getTextoBotonGuardar() }}
              </button>
            </div>

          </div>
        </div>
      </div>

    </form>
  </div>

</div>

<!-- Información de ayuda (footer) -->
<div class="mt-5 p-3 bg-light rounded" *ngIf="!cargando">
  <h6 class="text-muted mb-2">
    <i class="bi bi-info-circle me-2"></i>Tipos de Reglas de Delivery
  </h6>
  <div class="row">
    <div class="col-md-6">
      <small class="text-muted">
        <strong>ENVIO_GRATIS_500:</strong> Envío gratis para pedidos mayores a S/500<br>
        <strong>ENVIO_GRATIS_LIMA_350:</strong> Envío gratis en Lima para pedidos mayores a S/350<br>
        <strong>DISTRITO_ESPECIFICO:</strong> Tarifa específica para un distrito particular
      </small>
    </div>
    <div class="col-md-6">
      <small class="text-muted">
        <strong>LIMA_GENERAL:</strong> Tarifa general para todos los distritos de Lima<br>
        <strong>PROVINCIA:</strong> Tarifa para distritos fuera de Lima (provincias)<br>
        Las reglas se evalúan en el orden de prioridad definido por el sistema.
      </small>
    </div>
  </div>
</div>