<div class="container-fluid">
  
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="bi bi-truck me-2"></i>Mantenedor de Tarifas de Delivery
          </h2>
          <p class="text-muted mb-0">Gestión simplificada de costos de delivery</p>
        </div>
        <div>
          <button 
            type="button" 
            class="btn btn-success me-2" 
            (click)="nuevaTarifa()"
            *ngIf="puedeEditar()">
            <i class="bi bi-plus-circle me-2"></i>Nueva Tarifa
          </button>
          <button 
            type="button" 
            class="btn btn-outline-secondary" 
            (click)="refrescar()"
            [disabled]="cargando">
            <i class="bi bi-arrow-clockwise me-2"></i>Refrescar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Información del sistema simplificado -->
  <!-- <div class="alert alert-info mb-4">
    <h6 class="alert-heading mb-2">
      <i class="bi bi-info-circle me-2"></i>Sistema Simplificado de Delivery
    </h6>
    <p class="mb-0 small">
      El nuevo sistema evalúa automáticamente <strong>5 reglas en orden de prioridad</strong>: 
      (1) Envío gratis ≥ S/ 500, (2) Lima gratis ≥ S/ 350, (3) Tarifas por distrito específico, 
      (4) Lima general, (5) Provincias. Solo configure tarifas específicas según necesite.
    </p>
  </div> -->

  <!-- Filtros simplificados -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-funnel me-2"></i>Filtros y Búsqueda
      </h5>
    </div>
    <div class="card-body">
      
      <div class="row">
        <!-- Búsqueda por texto -->
        <div class="col-md-4">
          <label class="form-label">Buscar</label>
          <div class="input-group">
            <input
              type="text"
              class="form-control"
              placeholder="Buscar por ubicación o descripción..."
              [(ngModel)]="textoBusqueda"
              (keyup.enter)="buscarTexto()">
            <button 
              class="btn btn-outline-secondary" 
              type="button"
              (click)="buscarTexto()">
              <i class="bi bi-search"></i>
            </button>
            <button 
              class="btn btn-outline-secondary" 
              type="button"
              (click)="limpiarBusqueda()"
              *ngIf="textoBusqueda">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>

        <!-- Filtro por tipo de regla -->
        <div class="col-md-4">
          <label class="form-label">Tipo de Regla</label>
          <select 
            class="form-select"
            [(ngModel)]="filtros.tipoRegla"
            (change)="aplicarFiltros()">
            <option [value]="undefined">Todas las reglas</option>
            <option 
              *ngFor="let tipo of tiposReglaOptions" 
              [value]="tipo.value">
              {{ tipo.label }}
            </option>
          </select>
        </div>

        <!-- Filtro por distrito (solo para específicos) -->
        <div class="col-md-4" *ngIf="filtros.tipoRegla === 'DISTRITO_ESPECIFICO'">
          <label class="form-label">Distrito Específico</label>
          <select 
            class="form-select"
            [(ngModel)]="filtros.idDistrito"
            (change)="aplicarFiltros()">
            <option [value]="undefined">Todos los distritos</option>
            <option 
              *ngFor="let dist of distritos" 
              [value]="dist.idDistrito">
              {{ dist.nombre }}
            </option>
          </select>
        </div>

        <!-- Estado -->
        <div class="col-md-4" *ngIf="filtros.tipoRegla !== 'DISTRITO_ESPECIFICO'">
          <label class="form-label">Estado</label>
          <select 
            class="form-select"
            [(ngModel)]="filtros.activo"
            (change)="aplicarFiltros()">
            <option [value]="undefined">Todos los estados</option>
            <option [value]="true">Activas</option>
            <option [value]="false">Inactivas</option>
          </select>
        </div>
      </div>

      <!-- Botones de filtros -->
      <div class="d-flex gap-2 mt-3">
        <button 
          type="button" 
          class="btn btn-primary btn-sm"
          (click)="aplicarFiltros()">
          <i class="bi bi-funnel me-1"></i>Aplicar Filtros
        </button>
        <button 
          type="button" 
          class="btn btn-outline-secondary btn-sm"
          (click)="limpiarFiltros()">
          <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
        </button>
        <button 
          type="button" 
          class="btn btn-outline-info btn-sm"
          (click)="onTipoReglaChange()"
          *ngIf="filtros.tipoRegla === 'DISTRITO_ESPECIFICO'">
          <i class="bi bi-geo me-1"></i>Cargar Distritos
        </button>
      </div>
      
    </div>
  </div>

  <!-- Loading inicial -->
  <div *ngIf="cargando" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2 text-muted">Cargando tarifas de delivery...</p>
  </div>

  <!-- Tabla de tarifas simplificada -->
  <div class="card" *ngIf="!cargando">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-table me-2"></i>Tarifas Configuradas
        </h5>
        <div class="d-flex align-items-center gap-3">
          <small class="text-muted" *ngIf="collectionSize > 0">
            Mostrando {{ (page - 1) * pageSize + 1 }} - {{ Math.min(page * pageSize, collectionSize) }} 
            de {{ collectionSize }} tarifas
          </small>
          <div>
            <span class="badge bg-primary">{{ collectionSize }} Total</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card-body p-0">
      <!-- Tabla responsive -->
      <div class="table-responsive" *ngIf="collectionSize > 0">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Tipo de Regla</th>
              <th>Ubicación/Condición</th>
              <th>Tarifa</th>
              <th>Estado</th>
              <th>Última Modificación</th>
              <th class="text-center" *ngIf="puedeEditar()">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let tarifa of tarifasTable; trackBy: trackByTarifa">
              
              <!-- Tipo de Regla -->
              <td>
                <span 
                  class="badge px-3 py-2" 
                  [class]="'bg-' + getColorTipoRegla(tarifa.tipoRegla)">
                  {{ getDescripcionRegla(tarifa.tipoRegla) }}
                </span>
              </td>

              <!-- Ubicación/Condición -->
              <td>
                <div class="fw-semibold">{{ tarifa.ubicacionCompleta }}</div>
                <small class="text-muted">{{ tarifa.descripcion }}</small>
              </td>

              <!-- Tarifa -->
              <td>
                <div 
                  class="fw-bold fs-6"
                  [class]="(tarifa.precio ?? tarifa.tarifa ?? 0) === 0 ? 'text-success' : 'text-primary'">
                  {{ formatearPrecio(tarifa) }}
                </div>
              </td>

              <!-- Estado -->
              <td>
                <span 
                  class="badge" 
                  [class]="tarifa.activo ? 'bg-success' : 'bg-secondary'">
                  {{ getTextoEstado(tarifa.activo) }}
                </span>
              </td>

              <!-- Fecha -->
              <td>
                <small class="text-muted">
                  {{ formatearFecha(tarifa.fechaActualizacion || tarifa.fechaCreacion) }}
                </small>
              </td>

              <!-- Acciones -->
              <td class="text-center" *ngIf="puedeEditar()">
                <div class="btn-group btn-group-sm" role="group">
                  <button 
                    type="button" 
                    class="btn btn-outline-info"
                    (click)="verDetalle(tarifa, modalDetalle)"
                    ngbTooltip="Ver detalle">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button 
                    type="button" 
                    class="btn btn-outline-primary"
                    (click)="editarTarifa(tarifa)"
                    ngbTooltip="Editar">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <!-- <button 
                    type="button" 
                    class="btn btn-outline-secondary"
                    (click)="duplicarTarifa(tarifa)"
                    ngbTooltip="Duplicar">
                    <i class="bi bi-copy"></i>
                  </button> -->
                  <button 
                    type="button" 
                    class="btn btn-outline-danger"
                    (click)="eliminarTarifa(tarifa)"
                    ngbTooltip="Eliminar">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>

            </tr>
          </tbody>
        </table>
      </div>

      <!-- Estado vacío -->
      <div *ngIf="collectionSize === 0" class="text-center py-5">
        <i class="bi bi-inbox display-1 text-muted"></i>
        <h5 class="text-muted mt-3">No se encontraron tarifas</h5>
        <p class="text-muted">
          <span *ngIf="textoBusqueda || filtros.tipoRegla || filtros.activo !== undefined">
            Intente ajustar los filtros de búsqueda.
          </span>
          <span *ngIf="!textoBusqueda && !filtros.tipoRegla && filtros.activo === undefined">
            No hay tarifas de delivery configuradas. El sistema aplicará las reglas por defecto.
          </span>
        </p>
        <button 
          type="button" 
          class="btn btn-success" 
          (click)="nuevaTarifa()"
          *ngIf="puedeEditar() && !textoBusqueda && !filtros.tipoRegla && filtros.activo === undefined">
          <i class="bi bi-plus-circle me-2"></i>Configurar Primera Tarifa
        </button>
      </div>

    </div>

    <!-- Footer con paginación -->
    <div class="card-footer" *ngIf="collectionSize > pageSize">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <small class="text-muted">
            Mostrando {{ (page - 1) * pageSize + 1 }} - {{ Math.min(page * pageSize, collectionSize) }} 
            de {{ collectionSize }} tarifas
          </small>
        </div>
        <div>
          <ngb-pagination
            [(page)]="page"
            [pageSize]="pageSize"
            [collectionSize]="collectionSize"
            [maxSize]="5"
            [rotate]="true"
            [boundaryLinks]="true"
            (pageChange)="onPageChange()">
          </ngb-pagination>
        </div>
      </div>
    </div>

  </div>

</div>

<!-- Modal de Detalle Simplificado -->
<ng-template #modalDetalle let-modal>
  <div class="modal-header">
    <h4 class="modal-title">
      <i class="bi bi-info-circle me-2"></i>Detalle de Tarifa de Delivery
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      aria-label="Close" 
      (click)="modal.dismiss()">
    </button>
  </div>
  
  <div class="modal-body" *ngIf="tarifaSeleccionada">
    <div class="container-fluid">
      
      <!-- Tipo de Regla -->
      <div class="row mb-4">
        <div class="col-12">
          <h6 class="text-primary mb-3">
            <i class="bi bi-gear me-2"></i>Tipo de Regla
          </h6>
          <div class="mb-2">
            <span 
              class="badge px-3 py-2 fs-6" 
              [class]="'bg-' + getColorTipoRegla(tarifaSeleccionada.tipoRegla)">
              {{ getDescripcionRegla(tarifaSeleccionada.tipoRegla) }}
            </span>
          </div>
          <div class="small text-muted">
            {{ tarifaSeleccionada.descripcionRegla }}
          </div>
        </div>
      </div>

      <!-- Información de Aplicación -->
      <div class="row mb-4">
        <div class="col-md-6">
          <h6 class="text-success mb-3">
            <i class="bi bi-geo-alt me-2"></i>Aplicación
          </h6>
          <div class="mb-2">
            <strong>Ubicación:</strong> {{ tarifaSeleccionada.ubicacionCompleta }}
          </div>
          <div class="mb-2">
            <strong>Tarifa:</strong> 
            <span 
              class="fw-bold fs-5 ms-1"
              [class]="(tarifaSeleccionada.precio ?? tarifaSeleccionada.tarifa ?? 0) === 0 ? 'text-success' : 'text-primary'">
              {{ formatearPrecio(tarifaSeleccionada) }}
            </span>
          </div>
        </div>
        <div class="col-md-6">
          <h6 class="text-info mb-3">
            <i class="bi bi-clock me-2"></i>Estado y Fechas
          </h6>
          <div class="mb-2">
            <strong>Estado:</strong> 
            <span 
              class="badge ms-1" 
              [class]="tarifaSeleccionada.activo ? 'bg-success' : 'bg-secondary'">
              {{ getTextoEstado(tarifaSeleccionada.activo) }}
            </span>
          </div>
          <div class="mb-2">
            <strong>Creada:</strong> {{ formatearFecha(tarifaSeleccionada.fechaCreacion) }}
          </div>
          <div class="mb-2" *ngIf="tarifaSeleccionada.fechaActualizacion">
            <strong>Actualizada:</strong> {{ formatearFecha(tarifaSeleccionada.fechaActualizacion) }}
          </div>
        </div>
      </div>

      <!-- Información adicional para distrito específico -->
      <div class="row" *ngIf="tarifaSeleccionada.tipoRegla === 'DISTRITO_ESPECIFICO' && tarifaSeleccionada.distrito">
        <div class="col-12">
          <h6 class="text-warning mb-3">
            <i class="bi bi-map me-2"></i>Distrito Específico
          </h6>
          <div class="p-3 bg-light rounded">
            <div><strong>Distrito:</strong> {{ tarifaSeleccionada.distrito.nombre }}</div>
            <div class="small text-muted mt-1">
              Esta tarifa se aplica únicamente a entregas en este distrito específico.
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Cerrar</button>
    <button 
      type="button" 
      class="btn btn-primary" 
      (click)="modal.dismiss(); editarTarifa(tarifaSeleccionada)"
      *ngIf="puedeEditar() && tarifaSeleccionada">
      <i class="bi bi-pencil me-2"></i>Editar
    </button>
  </div>
</ng-template>