<div class="container-fluid p-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">
        <i class="pi pi-users me-2"></i>
        Reporte de Ventas por Tipo Cliente
      </h2>
    </div>
  </div>

  <!-- Filtros -->
  <p-card header="Filtros" class="mb-4">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Rango de Fecha</label>
        <p-dropdown
          [options]="rangosFecha"
          [(ngModel)]="filtrosVentasRol.rangoFechas"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccionar rango"
          (onChange)="onRangoFechaChange()"
          class="w-100"
          pTooltip="Seleccione un rango de fechas predefinido">
        </p-dropdown>
      </div>
      <div class="col-md-3">
        <label class="form-label">Fecha Inicio</label>
        <p-calendar
          [(ngModel)]="filtrosVentasRol.fechaInicio"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          class="w-100"
          pTooltip="Seleccione la fecha de inicio del reporte">
        </p-calendar>
      </div>
      <div class="col-md-3">
        <label class="form-label">Fecha Fin</label>
        <p-calendar
          [(ngModel)]="filtrosVentasRol.fechaFin"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          class="w-100"
          pTooltip="Seleccione la fecha de fin del reporte">
        </p-calendar>
      </div>
      <div class="col-md-3">
        <label class="form-label">Canal de Venta</label>
        <p-multiSelect
          [options]="canalesVenta"
          [(ngModel)]="filtrosVentasRol.canalesSeleccionados"
          optionLabel="nombre"
          optionValue="idCanalVenta"
          placeholder="Todos los canales"
          [showToggleAll]="true"
          class="w-100"
          pTooltip="Seleccione uno o más canales de venta">
        </p-multiSelect>
      </div>
      <div class="col-md-3">
        <label class="form-label">Tipo de Pago</label>
        <p-multiSelect
          [options]="tiposPago"
          [(ngModel)]="filtrosVentasRol.tiposPagoSeleccionados"
          optionLabel="nombre"
          optionValue="idTipoPago"
          placeholder="Todos los tipos"
          [showToggleAll]="true"
          class="w-100"
          pTooltip="Seleccione uno o más tipos de pago">
        </p-multiSelect>
      </div>
      <div class="col-md-3">
        <label class="form-label">Tipos Cliente</label>
        <p-multiSelect
          [options]="roles"
          [(ngModel)]="filtrosVentasRol.rolesSeleccionados"
          optionLabel="nombre"
          optionValue="idRol"
          placeholder="Todos los tipos"
          [showToggleAll]="true"
          class="w-100"
          pTooltip="Seleccione uno o más tipos cliente específicos">
        </p-multiSelect>
      </div>
      <div class="col-md-3">
        <label class="form-label">Clientes</label>
        <p-multiSelect
          [options]="clientes"
          [(ngModel)]="filtrosVentasRol.clientesSeleccionados"
          optionLabel="nombre"
          optionValue="idCliente"
          placeholder="Todos los clientes"
          [showToggleAll]="true"
          [filter]="true"
          filterBy="nombre,documento"
          class="w-100"
          pTooltip="Seleccione uno o más clientes específicos">
          <ng-template let-cliente pTemplate="item">
            <div class="flex align-items-center">
              <span class="font-medium">{{cliente.nombre}}</span>
              <small class="text-muted ms-2">{{cliente.documento}}</small>
            </div>
          </ng-template>
        </p-multiSelect>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <p-button
          label="Generar Reporte"
          icon="pi pi-search"
          (onClick)="aplicarFiltros()"
          class="w-100"
          pTooltip="Aplicar filtros y generar el reporte">
        </p-button>
      </div>
    </div>
  </p-card>

  <!-- KPIs -->
  <div class="row mb-4 mt-4">
    <div class="col-md-3">
      <p-card class="text-center kpi-card">
        <div class="kpi-value">S/ {{kpisVentasRol.total | number:'1.2-2'}}</div>
        <div class="kpi-label">Total Vendido</div>
      </p-card>
    </div>
    <div class="col-md-3">
      <p-card class="text-center kpi-card">
        <div class="kpi-value">{{kpisVentasRol.pedidos | number}}</div>
        <div class="kpi-label">Total Pedidos</div>
      </p-card>
    </div>
    <div class="col-md-3">
      <p-card class="text-center kpi-card">
        <div class="kpi-value">S/ {{kpisVentasRol.ticketPromedio | number:'1.2-2'}}</div>
        <div class="kpi-label">Ticket Promedio</div>
      </p-card>
    </div>
    <div class="col-md-3">
      <p-card class="text-center kpi-card">
        <div class="kpi-value">{{kpisVentasRol.recompra | number:'1.2-2'}}%</div>
        <div class="kpi-label">Tasa Recompra</div>
      </p-card>
    </div>
  </div>
  <div class="mb-4"></div>

  <!-- Gráficos -->
  <div class="row mb-4" *ngIf="datosVentasRol && datosVentasRol.length > 0; else noDataSection">
    <div class="col-md-6 mb-3">
      <p-card header="Ingresos por Tipo Cliente">
        <div class="chart-container">
          <canvas #ventasRolBarChart></canvas>
        </div>
      </p-card>
    </div>
    <div class="col-md-6 mb-3">
      <p-card header="Tendencia de Ventas por Tipo Cliente">
        <div class="chart-container">
          <canvas #ventasRolLineChart></canvas>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Tabla de datos -->
  <p-card header="Detalle por Tipo Cliente">
    <div class="mb-3">
      <p-button
        label="Exportar Excel"
        icon="pi pi-file-excel"
        class="p-button-success me-2"
        [disabled]="datosVentasRol.length === 0"
        (onClick)="exportarExcel()"
        pTooltip="Exportar datos a Excel">
      </p-button>
      <p-button
        label="Exportar PDF"
        icon="pi pi-file-pdf"
        class="p-button-danger"
        [disabled]="datosVentasRol.length === 0"
        (onClick)="exportarPDF()"
        pTooltip="Exportar reporte completo a PDF">
      </p-button>
    </div>
    <p-table [value]="datosVentasRol" [paginator]="true" [rows]="10" [responsive]="true">
      <ng-template pTemplate="header">
        <tr>
          <th>Tipo Cliente</th>
          <th># Pedidos</th>
          <th>Unidades</th>
          <th>Ingresos (S/)</th>
          <th>% Participación</th>
          <th>Clientes Únicos</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-item>
        <tr>
          <td>{{ item.nombre }}</td>
          <td>{{ item.pedidos | number }}</td>
          <td>{{ item.unidades | number }}</td>
          <td>{{ item.ingresos | currency:'PEN':'symbol':'1.2-2' }}</td>
          <td>{{ item.participacion | number:'1.1-1' }}%</td>
          <td>{{ item.clientesUnicos | number }}</td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center p-4">
            <i class="pi pi-info-circle" style="font-size: 2rem; color: #ccc;"></i>
            <p class="text-muted mt-2 mb-1">No hay datos disponibles</p>
            <small class="text-muted">Aplique filtros para generar el reporte</small>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Template para cuando no hay datos en gráficos -->
  <ng-template #noDataSection>
    <div class="row mb-4">
      <div class="col-12">
        <p-card>
          <div class="text-center p-5">
            <i class="pi pi-chart-bar text-muted" style="font-size: 4rem;"></i>
            <h4 class="text-muted mt-3">No hay datos para mostrar</h4>
            <p class="text-muted">Aplique filtros para generar los gráficos de ventas por tipo cliente</p>
          </div>
        </p-card>
      </div>
    </div>
  </ng-template>
</div>
